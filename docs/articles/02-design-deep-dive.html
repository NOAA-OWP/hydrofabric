<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content='"A joint USGS and NOAA effort"
'>
<title>The Reference Fabric • hydrofabric</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="The Reference Fabric">
<meta property="og:description" content='"A joint USGS and NOAA effort"
'>
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">hydrofabric</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/NOAA-OWP/hydrofabric/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>The Reference Fabric</h1>
                        <h4 data-toc-skip class="author">Mike
Johnson</h4>
            <address class="author_afil">
      Lynker,
NOAA-Affiliate<br><h4 data-toc-skip class="author">David
Blodgett</h4>
            <address class="author_afil">
      USGS
WMA<br><h4 data-toc-skip class="author">Andy
Bock</h4>
            <address class="author_afil">
      USGS
WMA<br><h4 data-toc-skip class="author">Angus
Watters</h4>
            <address class="author_afil">
      Lynker<br><small class="dont-index">Source: <a href="https://github.com/NOAA-OWP/hydrofabric/blob/HEAD/vignettes/02-design-deep-dive.Rmd" class="external-link"><code>vignettes/02-design-deep-dive.Rmd</code></a></small>
      <div class="d-none name"><code>02-design-deep-dive.Rmd</code></div>
    </address>
</address>
</address>
</address>
</div>

    
    
<div class="section level2">
<h2 id="how-do-we-arrive-at-the-nextgen-hydrofabric">How do we arrive at the NextGen Hydrofabric?<a class="anchor" aria-label="anchor" href="#how-do-we-arrive-at-the-nextgen-hydrofabric"></a>
</h2>
<ul>
<li><p>The NextGen model engine is intended to be <em>model
agnostic</em>.</p></li>
<li><p>The hydrofabric is meant to be <em>Model Application
Agnostic</em>.</p></li>
<li>
<p>This means that the hydrofabric should be able to support the
modeling needs of applications like:</p>
<ol style="list-style-type: decimal">
<li>NOAA NextGen (in its infinite flavors);</li>
<li>the USGS NHM;</li>
<li>the USGS SPARROW model;</li>
<li>and eventually NOAA FIM.</li>
</ol>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="the-usgs-noaa-reference-fabric">The USGS-NOAA Reference Fabric<a class="anchor" aria-label="anchor" href="#the-usgs-noaa-reference-fabric"></a>
</h2>
<ul>
<li><p>For a single system to serve many - often distinct - modeling
applications, there needs to be a set reference (analogous to a
coordinate reference system (CRS))</p></li>
<li>
<p>This reference system must provide the maximum (e.g. smallest
discretization) set of features “allowable” for all interrelated model
applications.</p>
<ul>
<li>Right now, this is the NHDPlusV2 (with modifications)</li>
<li>In the future it will move to NHDHighRes and 3DHP</li>
<li>In practice, reference fabrics can be built from other hydrographies
(e.g. NGA TDX and MERIT)</li>
</ul>
</li>
<li><p>A reference fabric is key to providing persistent identification
(PID) for durable data integration and model interoperability</p></li>
<li><p>The development of this product has been collaborative venture
between the USGS Water Mission Area, the NOAA Office of Water
Prediction, and Lynker.</p></li>
</ul>
<p><img src="../reference/figures/logos.png" width="898"></p>
<p>More on this has been documented <a href="https://waterdata.usgs.gov/blog/hydrofabric/" class="external-link">here</a></p>
<div class="section level3">
<h3 id="the-3-pillars-of-a-reference-fabric">The 3 pillars of a Reference Fabric<a class="anchor" aria-label="anchor" href="#the-3-pillars-of-a-reference-fabric"></a>
</h3>
<p><img src="../reference/figures/level1.png" width="708"></p>
<div class="section level4">
<h4 id="reference-fabric">1. Reference Fabric<a class="anchor" aria-label="anchor" href="#reference-fabric"></a>
</h4>
<ul>
<li><p>Simple, valid, representations of all <code>flowpath</code> and
<code>divide</code> features</p></li>
<li><p>Must be derived from a <em>source</em> hydrographic dataset
(e.g. NHDPlusV2, or Dihydro)</p></li>
<li><p>Currently, these are built out from the NHDPlusV2
features</p></li>
<li><p><strong>Waterbodies</strong> are simplified, islands are
dissolved, and they are unioned on GNIS_ID.</p></li>
</ul>
<p><img src="../reference/figures/cleaning_waterbodies.gif"><!-- --></p>
<ul>
<li>
<strong>Catchments</strong> are simplified, and DEM fragments are
dissolved into the proper adjoining catchments.</li>
</ul>
<p><img src="../reference/figures/cleaning_catchments.gif"><!-- --></p>
<ul>
<li><p><strong>Flowpaths</strong> are ensured to be digitized from
upstream to downstream and the burn line events are substituted for the
NHDFlowlines in headwater catchments</p></li>
<li><p>These data products can be found<a href="https://www.sciencebase.gov/catalog/item/6317a72cd34e36012efa4e8a" class="external-link">here</a></p></li>
</ul>
</div>
<div class="section level4">
<h4 id="reference-topology">2. Reference Topology<a class="anchor" aria-label="anchor" href="#reference-topology"></a>
</h4>
<ul>
<li><p>Since its release, the NHDPlus topology and value added
attributes have been stable</p></li>
<li><p>Local groups and agencies have made modifications to this but
these have never made it back into the primary source</p></li>
<li><p>Improvements made by the USGS, OWP, NCAR and others have been
integrated to provide an updated network connectivity.</p></li>
<li><p>This data product can be found <a href="https://www.sciencebase.gov/catalog/item/63cb311ed34e06fef14f40a3" class="external-link">here</a>
and is described in the upcoming article “Generating a reference flow
network with improved connectivity to support durable data integration
and reproducibility in the coterminous US” {In press at EMS}</p></li>
</ul>
<div class="section level5">
<h5 id="connecting-previously-terminal-flowlines-back-to-the-network">Connecting previously “terminal” flowlines back to the network<a class="anchor" aria-label="anchor" href="#connecting-previously-terminal-flowlines-back-to-the-network"></a>
</h5>
<p><img src="../reference/figures/figure6.png" width="620"></p>
</div>
<div class="section level5">
<h5 id="corrected-divergence-priorities">Corrected divergence priorities<a class="anchor" aria-label="anchor" href="#corrected-divergence-priorities"></a>
</h5>
<p><img src="../reference/figures/figure8.png" width="614"></p>
<ul>
<li>Ultimately a changed network as shown by areas where the total
drainage area is more then 10% different then the original NHDPlusV2
Network.</li>
</ul>
<p><img src="../reference/figures/figure9.png" width="613"></p>
</div>
</div>
<div class="section level4">
<h4 id="community-points-of-interest-poi">3. Community Points of Interest (POI)<a class="anchor" aria-label="anchor" href="#community-points-of-interest-poi"></a>
</h4>
<p>Points of Interest (POIs) for hydrologic modeling are collected from
a variety of of published data sources. These include ones like the Army
Corp National Inventory of Dams and the USGS Gages III gage database</p>
<ul>
<li><p>POIs become <code>hydrolocations</code> at the <em>outflow</em>
of the linked <code>flowpath</code> through a robust hydrologic indexing
scheme.</p></li>
<li><p><strong>NOTE</strong>: These are locations that have been deemed
of high <em>general</em> interest. There is no guarantee all gages,
dams, thermoelectric plants are in the community set.</p></li>
</ul>
</div>
</div>
</div>
<div class="section level2">
<h2 id="what-is-a-vpu">What is a VPU?<a class="anchor" aria-label="anchor" href="#what-is-a-vpu"></a>
</h2>
<p>A VPU is a <strong>V</strong>ector <strong>P</strong>rocessing
<strong>Unit</strong>. The USGS determined these regions when designing
the NHDPlusV2. Since our work builds off the NHDPlusV2, we adopt these
processing units.</p>
<pre><code><span><span class="co">## Warning in st_point_on_surface.sfc(sf::st_zm(x)): st_point_on_surface may not</span></span>
<span><span class="co">## give correct results for longitude/latitude data</span></span></code></pre>
<p><img src="02-design-deep-dive_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>All hydrographic networks have VPU-esque discritizations. The key is
that the source hydrofabric discritization can be retained through the
manipulation process.</p>
<p>Below we show the tiling and drainage basin approaches of
MERIT-hydro, BasinMaker, and NGA’s TDX-hydro.</p>
<div class="figure" style="text-align: center">
<img src="../reference/figures/merit-hydro.png" alt="caption" width="32%"><img src="../reference/figures/basinmaker.png" alt="caption" width="32%"><img src="../reference/figures/nga-tdx.png" alt="caption" width="32%"><p class="caption">
caption
</p>
</div>
</div>
<div class="section level2">
<h2 id="getting-the-reference-fabric">Getting the reference fabric<a class="anchor" aria-label="anchor" href="#getting-the-reference-fabric"></a>
</h2>
<p>All reference products live on Lynker Spatial s3 account.</p>
<p>They can be accessed with the web interface, downloaded, or
interfaced with arrow.</p>
<p>The <code>hydrofab::get_hydrofabric()</code> utility will download
the most current geofabric for a Vector Processing Unit (VPU).</p>
<p>As an example, lets use the Geonconnex reference features to identify
the location of our Fort Collins gage.</p>
<p>This location can be joined to the set of VPU boundaries severed with
<code>nhdplusTools</code> to find the correct VPU.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">gage</span> <span class="op">=</span> <span class="fu"><a href="https://arrow.apache.org/docs/r/reference/open_dataset.html" class="external-link">open_dataset</a></span><span class="op">(</span><span class="st">'s3://lynker-spatial/hydrofabric/v2.2/conus_hl'</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="st">"vpuid"</span>, <span class="st">'hl_reference'</span>, <span class="st">"hl_link"</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">hl_link</span> <span class="op">==</span> <span class="st">'06752260'</span><span class="op">)</span> <span class="op">%&gt;%</span> </span>
<span>  <span class="fu">collect</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 3</span></span></span>
<span><span class="co">##   vpuid hl_reference   hl_link </span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   </span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> 10L   Gages          06752260</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> 10L   usgs_site_code 06752260</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">reference_gpkg</span> <span class="op">=</span> <span class="fu">get_vpu_fabric</span><span class="op">(</span>vpu <span class="op">=</span> <span class="va">gage</span><span class="op">$</span><span class="va">vpuid</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>                                outfile <span class="op">=</span> <span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"tutorial/vpu_{gage$vpuid[1]}.gpkg"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in get_vpu_fabric(vpu = gage$vpuid[1], outfile =</span></span>
<span><span class="co">## glue("tutorial/vpu_{gage$vpuid[1]}.gpkg")): tutorial/vpu_10L.gpkg already</span></span>
<span><span class="co">## exists and overwrite is FALSE</span></span></code></pre>
<p>If the requested file already exists, the file path will be
returned.</p>
<p>Ok! With that, we have an idea of what the reference fabric is, how
it was made, and how we can get it! The next stage is to learn how to
manipulate this reference fabric for unique model applications.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://mikejohnson51.github.io/" class="external-link">Mike Johnson</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
